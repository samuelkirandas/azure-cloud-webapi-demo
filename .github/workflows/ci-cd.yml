name: Build and Deploy to Azure Container Instance

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore MyCloudApp/MyCloudApp.csproj

    - name: Build
      run: dotnet build --configuration Release --no-restore MyCloudApp/MyCloudApp.csproj

    - name: Publish
      run: dotnet publish MyCloudApp/MyCloudApp.csproj -c Release -o MyCloudApp/out

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure Container Registry Login
      run: az acr login --name ${{ secrets.REGISTRY_NAME }}

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ secrets.IMAGE_NAME }}:${{ github.sha }} -f MyCloudApp/Dockerfile MyCloudApp

    - name: Push Docker image
      run: |
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ secrets.IMAGE_NAME }}:${{ github.sha }}

    - name: Deploy to Azure Container Instance
      run: |
        az container create \
          --resource-group ${{ secrets.RESOURCE_GROUP }} \
          --name ${{ secrets.ACI_NAME }} \
          --image ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ secrets.IMAGE_NAME }}:${{ github.sha }} \
          --registry-login-server ${{ secrets.REGISTRY_LOGIN_SERVER }} \
          --registry-username ${{ secrets.REGISTRY_NAME }} \
          --registry-password $(az acr credential show --name ${{ secrets.REGISTRY_NAME }} --query "passwords[0].value" -o tsv) \
          --cpu 1 --memory 1.5 --os-type Linux --ports 80 \
          --dns-name-label ${{ secrets.ACI_NAME }}
